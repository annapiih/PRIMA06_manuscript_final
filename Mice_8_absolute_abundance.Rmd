---
title: "PRIMA06 Absolute abundance"
author: "annapiih"
date: '`r Sys.Date()`'
output:
  rmdformats::readthedown:
    toc_depth: 4
    collapsed: false
    code_folding: hide
    number_sections: true
knit: (function(inputFile, encoding) { 
    rmarkdown::render(
        inputFile, encoding = encoding,
        output_dir = file.path(dirname(inputFile),"output"),
        output_file = paste0("PRIMA06_", Sys.Date(), "_absolute_abundance.html")) 
    })
---

# Intro {.tabset .tabset-fade .tabset-pills}

This markdown contains commands for analysing metadata in animal studies (transit time, body weight, food intake, etc.). 

By default, R uses the folder where the markdown file is saved as the working directory  


```{r setup, eval=TRUE, echo=TRUE, message=FALSE,warning = FALSE}
knitr::opts_chunk$set(echo = TRUE ,warning = FALSE, message = FALSE)

# Load libraries
library(tidyverse)
library(phyloseq)
library(ggpubr)
library(rstatix)
library(kableExtra)
library(picante)
library(readr)
library(forcats)
library(ggsci)
library (RColorBrewer)
library(viridis)
library(ggpmisc)
library(multipanelfigure)
library(ggplot2)
library(grid)

# Create used folders if missing
if (!file.exists("plots")) dir.create(file.path(getwd(), "plots"))
if (!file.exists("scripts")) dir.create(file.path(getwd(), "scripts"))
if (!file.exists("output")) dir.create(file.path(getwd(), "output"))

```

# Bacterial load 
## All days + groups
### Prepare dataset 
```{r load_prepare, eval = TRUE}
# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

head(dat)

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

# Make sure that data is in correct order (for paired analysis)
dat <- dat[order(dat$Day),]

# Test normality 
shapiro_test(dat, bac_load_log) # Normally distributed 

ggqqplot(dat,x = "bac_load_log") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(bac_load_log~Group) # Assumption is met 

```

### Visualization + summary statistics 
```{r load_visualize, eval = TRUE}

# Get summary statistics 
dat %>% 
  group_by(Group, Day) %>% 
  get_summary_stats(bac_load_log, type = "common")

# Seperate data to make seperate plots for each group 
dat_load_con <- dat[dat$Group %in% c('Control'),] 
dat_load_low <- dat[dat$Group %in% c('Low'),] 
dat_load_med <- dat[dat$Group %in% c('Medium'),] 
dat_load_high <- dat[dat$Group %in% c('High'),]

# Set colors 
my_cols_con <- c("#fbb4ae", "#ff6666", "#CC0000")
my_cols_low <- c("#99CCFF","#3366CC","#003399")
my_cols_med <- c("darkseagreen2", "#00CC33", "green4")
my_cols_high <- c("#e9dbf9", "#c994c7", "#88419d")

# Visualise data 
plot_con <- dat_load_con %>%
  ggboxplot(x = "Day",
           y = "bac_load_log",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#ff6666") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(9, 11), breaks = scales::pretty_breaks(n=3))+
  ylab("16S copies/g feces (log)")+
  theme_classic()+
  ggtitle("Control")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank())+
  scale_fill_manual(values = my_cols_con)+
stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot_low <- dat_load_low %>%
  ggboxplot(x = "Day",
           y = "bac_load_log",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#3366CC") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(9, 11), breaks = scales::pretty_breaks(n=3))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("Low dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_low)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot_med <- dat_load_med %>%
  ggboxplot(x = "Day",
           y = "bac_load_log",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#00CC33") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(9, 11), breaks = scales::pretty_breaks(n=3))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("Medium dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_med)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot_high <- dat_load_high %>%
  ggboxplot(x = "Day",
           y = "bac_load_log",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#c994c7") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(9, 11), breaks = scales::pretty_breaks(n=3))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("High dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_high)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

```

### Statistical testing 

```{r load_stat, eval = TRUE}

# Two-way anova for repeated measures 
two.way <- anova_test(data = dat, 
                      dv = !!sym("bac_load_log"), 
                      wid = !!sym("Animal"), 
                      between = !!sym("Group"),
                      within = !!sym("Day"))
get_anova_table(two.way) # Significant difference for Day

# Post hoc tests 
stat.test.con <- dat_load_con %>% 
  t_test(bac_load_log~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.low <- dat_load_low %>% 
  t_test(bac_load_log~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.med <- dat_load_med %>% 
  t_test(bac_load_log~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.high <- dat_load_high %>% 
  t_test(bac_load_log~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

# Create output plot
My_Theme = theme(plot.title = element_text(size = 10)) # For setting the text sizes in the plot 

plot_con_final <- plot_con + My_Theme + 
  stat_pvalue_manual(stat.test.con, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE)

plot_low_final <- plot_low + My_Theme + 
  stat_pvalue_manual(stat.test.low, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE) 

plot_med_final <- plot_med + My_Theme + 
  stat_pvalue_manual(stat.test.med, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE) 

plot_high_final <- plot_high + My_Theme +  
  stat_pvalue_manual(stat.test.high, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE) 

plot_final <- ggarrange(plot_con_final, plot_low_final, plot_med_final, plot_high_final, ncol=4, nrow=1)

plot_final <- annotate_figure(plot_final, top = text_grob("Bacterial load in feces", color = "black", face = "bold"))

filename <- paste0("plots/Absolute_abundance/Bacload.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 2000, height = 1400, units = "px", dpi = "print", device = "png", ))

# Clear the environment and release memory
 rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
 invisible(gc())
 
```


## Day 9 
#### Prepare dataset 
```{r load_d09_prepare, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D09'),] 

shapiro_test(dat, bac_load_log) # Not normally distributed 
ggqqplot(dat,x = "bac_load_log")

```


#### Visualization + summary statistics 
```{r load_d09_visualize, eval = TRUE}

# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(bac_load_log, type = "common")

# Visualize data (new version)
plot <-ggboxplot(dat, 
                     x = "Group", 
                     y = "bac_load_log",
                     fill = "Group", 
                     palette = "Pastel1", 
                     outlier.shape = NA) + 
  geom_point(size = 0.5, color = "black") +
  ylab("16S copies/g feces (log)")+
  xlab(NULL)+
  ggtitle("Bacterial load day 9")+
  scale_y_continuous(limits=c(9, 11), breaks = scales::pretty_breaks(n=4))+
  theme_classic()+
  theme(legend.position="none")+ 
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

```

#### Statistical testing 

```{r load_d09_stat, eval = TRUE}

kruskal <- kruskal.test(bac_load_log ~ Group, data = dat) # Not significant 

# Create output plots 
My_Theme = theme( 
  plot.title = element_text(size = 12)) # For setting the text sizes in the plot 

# Save plot 
filename <- paste0("plots/Absolute_abundance/bacload_d09.png")
plot + My_Theme
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", )) 

# Clear the environment and release memory
 rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
 invisible(gc())
 

```

# Erysipelotrichaceae {.tabset .tabset-fade .tabset-pills}

## Day 9 
#### Prepare dataset 
```{r Erysipelotrichaceae_d09_prep, eval = TRUE}
# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D09'),] 

# Test normality 
shapiro_test(dat, Erysipelotrichaceae) # Not normally distributed 

ggqqplot(dat,x = "Erysipelotrichaceae") 

```

#### Visualization + summary statistics 
```{r Erysipelotrichaceae_d09_vis, eval = TRUE}

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Erysipelotrichaceae",
           fill = "Group") + 
  scale_color_brewer(palette = "Pastel1")+
  geom_point(size = 1, color = "black") +
  scale_y_continuous(limits=c(6, 12))+
  ylab("Absolute abundance (log)")+
  xlab(NULL)+
  ggtitle("Erysipelotrichaceae (day 9)")+
  theme_classic()+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))
  
# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Erysipelotrichaceae, type = "common")

```

#### Statistical testing 

```{r Erysipelotrichaceae_d09_stat, eval = TRUE}

# Kruskal wallis 
kruskal <- kruskal_test(Erysipelotrichaceae ~ Group, data = dat) # Significant 

# Post hoc test 
stat.test <- dat %>% 
  dunn_test(Erysipelotrichaceae~Group, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Group", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

# Create output plots 
My_Theme = theme( 
  plot.title = element_text(size = 12)) 

plot_final <- plot + 
  My_Theme +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE, y.position = c(11,11.3,11.6))


# Save plot 
filename <- paste0("plots/Absolute_abundance/Erysipelotrichaceae_d09.png")
plot_final 
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", )) 

# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```


## Day 2
#### Prepare dataset 
```{r Erysipelotrichaceae_d02_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")


# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D02'),] 

# Test normality 
shapiro_test(dat, Erysipelotrichaceae) # Normally distributed 

ggqqplot(dat,x = "Erysipelotrichaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Erysipelotrichaceae~Group) # Assumption not met

```

#### Visualization + summary statistics 
```{r Erysipelotrichaceae_d02_vis, eval = TRUE}

# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Erysipelotrichaceae, type = "common")

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Erysipelotrichaceae",
           fill = "Group") + 
  scale_color_brewer(palette = "Pastel1")+
  geom_point(size = 1, color = "black") +
  scale_y_continuous(limits=c(8, 12))+
  ylab("Absolute abundance (log)")+
  xlab(NULL)+
  ggtitle("Erysipelotrichaceae (Day 2)")+
  theme_classic()+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

```

#### Statistical testing 

```{r Erysipelotrichaceae_d02_stat, eval = TRUE}

# Kruskal Wallis test 
kruskal <- kruskal.test(Erysipelotrichaceae ~ Group, data = dat) # Not significant 

filename <- paste0("plots/Absolute_abundance/Erysipelotrichaceae_d02.png")
plot
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))

# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```


## Correlation with TT 
```{r correlation_Erysipelotrichaceae, eval = TRUE}
# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

My_Theme = theme(
  plot.title = element_text(size = 12)) # For setting the text sizes in the plot

# Plot for absolute abundance day 2 vs TT day 2 
dat_D02 <- dat[dat$Day %in% c('D02'),] 

plot_D02 <- ggscatter(dat_D02, x = "TT_D02", y = "Erysipelotrichaceae", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (day 2)", ylab = "Absolute abundance (day 2)") + 
  theme_classic()+ggtitle("Erysipelotrichaceae")#+scale_y_continuous(limits=c(6,12))

filename <- paste0("plots/Absolute_abundance/Erysipelotrichaceae_corr_d02.png")
plot_D02 <- plot_D02 + My_Theme  
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))

# Plot for absolute abundance day 5 vs TT day 5 
dat_D05 <- dat[dat$Day %in% c('D05'),] 

plot_D05 <- ggscatter(dat_D05, x = "TT_D05", y = "Erysipelotrichaceae", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (day 5)", ylab = "Absolute abundance (day 5)") + 
  theme_classic()+ggtitle("Erysipelotrichaceae")+ 
  scale_y_continuous(limits=c(6,12))

filename <- paste0("plots/Absolute_abundance/Erysipelotrichaceae_corr_d05.png")
plot_D05 <- plot_D05 + My_Theme  
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))
  

# Plot for relative abundance day 9 vs TT average D08/D10 
dat_av <- dat[dat$Day %in% c('D09'),] 

plot_av <- ggscatter(dat_av, x = "TT_AV", y = "Erysipelotrichaceae", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (average D08/D10)", ylab = "Absolute abundance (day 9)") + 
  theme_classic()+ggtitle("Erysipelotrichaceae")+  
  scale_y_continuous(limits=c(6, 12))

filename <- paste0("plots/Absolute_abundance/Erysipelotrichaceae_corr_av.png")
plot_av <- plot_av + My_Theme 
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))

# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```

## Trajectories 
#### Prepare dataset 
```{r Erysipelotrichaceae_trajectories_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor)

# Make sure that data is in correct order (for paired analysis)
dat <- dat[order(dat$Day),]

# Test normality 
shapiro_test(dat, Erysipelotrichaceae) # Normally distributed 

ggqqplot(dat,x = "Erysipelotrichaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Erysipelotrichaceae~Day) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Erysipelotrichaceae_trajectories_vis, eval = TRUE}

# Get summary statistics 
dat %>% 
  group_by(Group, Day) %>% 
  get_summary_stats(Erysipelotrichaceae, type = "common")

# Seperate data to make seperate plots for each group 
dat_con <- dat[dat$Group %in% c('Control'),] 
dat_low <- dat[dat$Group %in% c('Low'),] 
dat_med <- dat[dat$Group %in% c('Medium'),] 
dat_high <- dat[dat$Group %in% c('High'),]

# Set colors 
my_cols_con <- c("#fbb4ae", "#ff6666", "#CC0000")
my_cols_low <- c("#99CCFF","#3366CC","#003399")
my_cols_med <- c("darkseagreen2", "#00CC33", "green4")
my_cols_high <- c("#e9dbf9", "#c994c7", "#88419d")

# Visualise data 
plot_con <- dat_con %>%
  ggboxplot(x = "Day",
           y = "Erysipelotrichaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#ff6666") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(7, 11), breaks = scales::pretty_breaks(n=4))+
  ylab("Absolute abundance (log)")+
  theme_classic()+
  ggtitle("Control")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank())+
  scale_fill_manual(values = my_cols_con)+
stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot_low <- dat_low %>%
  ggboxplot(x = "Day",
           y = "Erysipelotrichaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#6699CC") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(7, 11), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("Low dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_low)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

# Visualise data 
plot_med <- dat_med %>%
  ggboxplot(x = "Day",
           y = "Erysipelotrichaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#00CC33") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(7, 11), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("Medium dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_low)+
  scale_fill_manual(values = my_cols_med)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

# Visualise data 
plot_high <- dat_high %>%
  ggboxplot(x = "Day",
           y = "Erysipelotrichaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#c994c7") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(7, 11), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("High dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_high)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

```

### Statistical testing 

```{r Erysipelotrichaceae_trajectories_stat, eval = TRUE}

# Two-way anova for repeated measures 
two.way <- anova_test(data = dat, 
                      dv = !!sym("Erysipelotrichaceae"), 
                      wid = !!sym("Animal"), 
                      between = !!sym("Group"),
                      within = !!sym("Day"))
get_anova_table(two.way) # Significant difference for Group and Day

# Post hoc tests 
stat.test.con <- dat_con %>% 
  t_test(Erysipelotrichaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.low <- dat_low %>% 
  t_test(Erysipelotrichaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.med <- dat_med %>% 
  t_test(Erysipelotrichaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.high <- dat_high %>% 
  t_test(Erysipelotrichaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)
```


### Output plot
```{r Erysipelotrichaceae_trajectories_output, eval = TRUE}

# Create output plot
My_Theme = theme(plot.title = element_text(size = 10)) 

plot_con_final <- plot_con + My_Theme + 
  stat_pvalue_manual(stat.test.con, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE)

plot_low_final <- plot_low + My_Theme + 
  stat_pvalue_manual(stat.test.low, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE) 

plot_med_final <- plot_med + My_Theme + 
  stat_pvalue_manual(stat.test.med, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE) 

plot_high_final <- plot_high + My_Theme +  
  stat_pvalue_manual(stat.test.high, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE) 

plot_final <- ggarrange(plot_con_final, plot_low_final, plot_med_final, plot_high_final, ncol=4, nrow=1)

plot_final <- annotate_figure(plot_final, top = text_grob("Erysipelotrichaceae", color = "black", face = "bold"))

filename <- paste0("plots/Absolute_abundance/Erysipelotrichaceae.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 2000, height = 1400, units = "px", dpi = "print", device = "png", ))

# Clear the environment and release memory
 rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
 invisible(gc())
 
```


# Bacteroidaceae {.tabset .tabset-fade .tabset-pills}
## Day 9 
#### Prepare dataset 
```{r Bacteroidaceae_d09_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")


# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D09'),] 

# Test normality 
shapiro_test(dat, Bacteroidaceae) # Normally distributed 

ggqqplot(dat,x = "Bacteroidaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Bacteroidaceae~Group) # Assumption is met 
```

#### Visualization + summary statistics 
```{r Bacteroidaceae_d09_vis, eval = TRUE}

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Bacteroidaceae",
           fill = "Group") +
  geom_point(size = 1, color = "black") +
  scale_y_continuous(limits=c(8, 12))+
  ylab("Absolute abundance (log)")+
  ggtitle("Bacteroidaceae (day 9)")+
  xlab(NULL)+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))


# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Bacteroidaceae, type = "common")

```

#### Statistical testing 

```{r Bacteroidaceae_d09_stat, eval = TRUE}

# ANOVA  
anova <- aov(Bacteroidaceae ~ Group, data = dat)
summary(anova)

# Post hoc test 
stat.test <- dat %>% 
  t_test(Bacteroidaceae~Group, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Group", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

# Create output plots 
My_Theme = theme( 
  plot.title = element_text(size = 12)) 

plot_final <- plot + 
  My_Theme +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE, y.position = c(11,11.3,11.6))

filename <- paste0("plots/Absolute_abundance/Bacteroidaceae_d09.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))
 
# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```

## Day 2
#### Prepare dataset 
```{r Bacteroidaceae_d02_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")


# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D02'),] 

# Test normality 
shapiro_test(dat, Bacteroidaceae) # Normally distributed 

ggqqplot(dat,x = "Bacteroidaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Bacteroidaceae~Group) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Bacteroidaceae_d02_vis, eval = TRUE}

# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Bacteroidaceae, type = "common")

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Bacteroidaceae",
           fill = "Group") + 
  scale_color_brewer(palette = "Pastel1")+
  geom_point(size = 1, color = "black") +
  scale_y_continuous(limits=c(8, 12))+
  ylab("Absolute abundance (log)")+
  xlab(NULL)+
  ggtitle("Bacteroidaceae (Day 2)")+
  theme_classic()+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))
  

```

#### Statistical testing 

```{r Bacteroidaceae_d02_stat, eval = TRUE}

# ANOVA  
anova <- aov(Bacteroidaceae ~ Group, data = dat)
summary(anova)

# Post hoc test 
stat.test <- dat %>% 
  t_test(Bacteroidaceae~Group, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Group", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

plot_final <- plot + 
  stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE)


filename <- paste0("plots/Absolute_abundance/Bacteroidaceae_d02.png")
plot_final 
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))
 
# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```

## Correlation with TT 
```{r correlation_Bacteroidaceae, eval = TRUE}
# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

My_Theme = theme(
  plot.title = element_text(size = 12)) 

# Plot for absolute abundance day 2 vs TT day 2 
dat_D02 <- dat[dat$Day %in% c('D02'),] 

plot_D02 <- ggscatter(dat_D02, x = "TT_D02", y = "Bacteroidaceae", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (day 2)", ylab = "Absolute abundance (day 2)") + 
  theme_classic()+ggtitle("Bacteroidaceae")#+scale_y_continuous(limits=c(6,12))

filename <- paste0("plots/Absolute_abundance/Bacteroidaceae_corr_d02.png")
plot_D02 <- plot_D02 + My_Theme  
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))

# Plot for absolute abundance day 5 vs TT day 5 
dat_D05 <- dat[dat$Day %in% c('D05'),] 

plot_D05 <- ggscatter(dat_D05, x = "TT_D05", y = "Bacteroidaceae", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (day 5)", ylab = "Absolute abundance (day 5)") + 
  theme_classic()+ggtitle("Bacteroidaceae")+ 
  scale_y_continuous(limits=c(8,12))

filename <- paste0("plots/Absolute_abundance/Bacteroidaceae_corr_d05.png")
plot_D05 <- plot_D05 + My_Theme  
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))
  

# Plot for relative abundance day 9 vs TT average D08/D10 
dat_av <- dat[dat$Day %in% c('D09'),] 

plot_av <- ggscatter(dat_av, x = "TT_AV", y = "Bacteroidaceae", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (average D08/D10)", ylab = "Absolute abundance (day 9)") + 
  theme_classic()+ggtitle("Bacteroidaceae")+  
  scale_y_continuous(limits=c(8, 12))

filename <- paste0("plots/Absolute_abundance/Bacteroidaceae_corr_av.png")
plot_av <- plot_av + My_Theme 
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))

# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```

## Trajectories 
#### Prepare dataset 
```{r Bacteroidaceae_trajectories_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor)

# Make sure that data is in correct order (for paired analysis)
dat <- dat[order(dat$Day),]

# Test normality 
shapiro_test(dat, Bacteroidaceae) # Normally distributed 

ggqqplot(dat,x = "Bacteroidaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Bacteroidaceae~Day) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Bacteroidaceae_trajectories_vis, eval = TRUE}

# Get summary statistics 
dat %>% 
  group_by(Group, Day) %>% 
  get_summary_stats(Bacteroidaceae, type = "common")

# Seperate data to make seperate plots for each group 
dat_con <- dat[dat$Group %in% c('Control'),] 
dat_low <- dat[dat$Group %in% c('Low'),] 
dat_med <- dat[dat$Group %in% c('Medium'),] 
dat_high <- dat[dat$Group %in% c('High'),]

# Set colors 
my_cols_con <- c("#fbb4ae", "#ff6666", "#CC0000")
my_cols_low <- c("#99CCFF","#3366CC","#003399")
my_cols_med <- c("darkseagreen2", "#00CC33", "green4")
my_cols_high <- c("#e9dbf9", "#c994c7", "#88419d")

# Visualise data 
plot_con <- dat_con %>%
  ggboxplot(x = "Day",
           y = "Bacteroidaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#ff6666") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(8, 11), breaks = scales::pretty_breaks(n=4))+
  ylab("Absolute abundance (log)")+
  theme_classic()+
  ggtitle("Control")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank())+
  scale_fill_manual(values = my_cols_con)+
stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot_low <- dat_low %>%
  ggboxplot(x = "Day",
           y = "Bacteroidaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#6699CC") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(8, 11), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("Low dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_low)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

# Visualise data 
plot_med <- dat_med %>%
  ggboxplot(x = "Day",
           y = "Bacteroidaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#00CC33") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(8, 11), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("Medium dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_low)+
  scale_fill_manual(values = my_cols_med)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

# Visualise data 
plot_high <- dat_high %>%
  ggboxplot(x = "Day",
           y = "Bacteroidaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#c994c7") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(8, 11), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("High dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_high)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

```

### Statistical testing 

```{r Bacteroidaceae_trajectories_stat, eval = TRUE}

# Two-way anova for repeated measures 
two.way <- anova_test(data = dat, 
                      dv = !!sym("Bacteroidaceae"), 
                      wid = !!sym("Animal"), 
                      between = !!sym("Group"),
                      within = !!sym("Day"))
get_anova_table(two.way) # Significant difference for Group and Day

# Post hoc tests 
stat.test.con <- dat_con %>% 
  t_test(Bacteroidaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.low <- dat_low %>% 
  t_test(Bacteroidaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.med <- dat_med %>% 
  t_test(Bacteroidaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.high <- dat_high %>% 
  t_test(Bacteroidaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

```


### Output plot
```{r Bacteroidaceae_trajectories_output, eval = TRUE}

# Create output plot
My_Theme = theme(plot.title = element_text(size = 10)) 

plot_con_final <- plot_con + My_Theme + 
  stat_pvalue_manual(stat.test.con, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE)

plot_low_final <- plot_low + My_Theme + 
  stat_pvalue_manual(stat.test.low, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE) 

plot_med_final <- plot_med + My_Theme + 
  stat_pvalue_manual(stat.test.med, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE) 

plot_high_final <- plot_high + My_Theme +  
  stat_pvalue_manual(stat.test.high, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE) 

plot_final <- ggarrange(plot_con_final, plot_low_final, plot_med_final, plot_high_final, ncol=4, nrow=1)

plot_final <- annotate_figure(plot_final, top = text_grob("Bacteroidaceae", color = "black", face = "bold"))

filename <- paste0("plots/Absolute_abundance/Bacteroidaceae.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 2000, height = 1400, units = "px", dpi = "print", device = "png", ))

# Clear the environment and release memory
 rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
 invisible(gc())
 
```


# Porphyromonadaceae {.tabset .tabset-fade .tabset-pills}

## Day 9 
#### Prepare dataset 
```{r Porphyromonadaceae_d09_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D09'),] 

# Test normality 
shapiro_test(dat, Porphyromonadaceae) # Normally distributed 

ggqqplot(dat,x = "Porphyromonadaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Porphyromonadaceae~Group) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Porphyromonadaceae_d09_vis, eval = TRUE}

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Porphyromonadaceae",
           fill = "Group") + 
  geom_point(size = 1, color = "black") +
  scale_y_continuous(limits=c(7,12))+
  ylab("Absolute abundance (log)")+
  ggtitle("Porphyromonadaceae (day 9)")+
  xlab(NULL)+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))


# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Porphyromonadaceae, type = "common")

```

#### Statistical testing 

```{r Porphyromonadaceae_d09_stat, eval = TRUE}

#ANOVA  
anova <- aov(Porphyromonadaceae ~ Group, data = dat)
summary(anova) # Significant 

# Post hoc test 
stat.test <- dat %>% 
  t_test(Bacteroidaceae~Group, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Group", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)


# Create output plots 
My_Theme = theme(, 
  plot.title = element_text(size = 12))  

plot_final <- plot + 
  My_Theme +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE, y.position =c(11,11.3,11.6))


filename <- paste0("plots/Absolute_abundance/Porphyromonadaceaee_d09_log.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))

# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```

## Day 2
#### Prepare dataset 
```{r Porphyromonadaceae_d02_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")


# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D02'),] 

# Test normality 
shapiro_test(dat, Porphyromonadaceae) # Normally distributed 

ggqqplot(dat,x = "Porphyromonadaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Porphyromonadaceae~Group) # Assumption is met

```

#### Visualization + summary statistics 
```{r Porphyromonadaceae_d02_vis, eval = TRUE}

# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Porphyromonadaceae, type = "common")

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Porphyromonadaceae",
           fill = "Group") + 
  scale_color_brewer(palette = "Pastel1")+
  geom_point(size = 1, color = "black") +
  ylab("Absolute abundance (log)")+
  xlab(NULL)+
  ggtitle("Porphyromonadaceae (Day 2)")+
  theme_classic()+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))
  

```

#### Statistical testing 
```{r Porphyromonadaceae_d02_stat, eval = TRUE}

#ANOVA  
anova <- aov(Porphyromonadaceae ~ Group, data = dat)
summary(anova) # not significant 

filename <- paste0("plots/Absolute_abundance/Porphyromonadaceaee_d02.png")
plot
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))
 
# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```


## Correlation with TT 
```{r correlation_Porphyromonadaceae, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

My_Theme = theme(
  plot.title = element_text(size = 12)) 

# Plot for absolute abundance day 2 vs TT day 2 
dat_D02 <- dat[dat$Day %in% c('D02'),] 

plot_D02 <- ggscatter(dat_D02, x = "TT_D02", y = "Porphyromonadaceae", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (day 2)", ylab = "Absolute abundance (day 2)") + 
  theme_classic()+ggtitle("Porphyromonadaceae")#+scale_y_continuous(limits=c(6,12))

filename <- paste0("plots/Absolute_abundance/Porphyromonadaceae_corr_d02.png")
plot_D02 <- plot_D02 + My_Theme  
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))

# Plot for relative abundance day 5 vs TT day 5 
# Create the new dataset 
dat_D05 <- dat[dat$Day %in% c('D05'),] 

plot_D05 <- ggscatter(dat_D05, x = "TT_D05", y = "Porphyromonadaceae", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (day 5)", ylab = "Absolute abundance (day 5)") + 
  theme_classic()+ggtitle("Porphyromonadaceae")+ 
  scale_y_continuous(limits=c(7, 12))
  
filename <- paste0("plots/Absolute_abundance/Porphyromonadaceae_corr_D05.png")
plot_D05 <- plot_D05 + My_Theme
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))

# Plot for relative abundance day 9 vs TT average of D08/D10 
# Create the new dataset 
dat_av <- dat[dat$Day %in% c('D09'),] 

plot_av <- ggscatter(dat_av, x = "TT_AV", y = "Porphyromonadaceae", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (average D08/D10)", ylab = "Absolute abundance (day 9)") + 
  theme_classic()+ggtitle("Porphyromonadaceae")+  
  scale_y_continuous(limits=c(7,12))

filename <- paste0("plots/Absolute_abundance/Porphyromonadaceae_corr_av.png")
plot_av <- plot_av + My_Theme
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))


# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```


## Trajectories 
#### Prepare dataset 
```{r Porphyromonadaceae_trajectories_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor)

# Make sure that data is in correct order (for paired analysis)
dat <- dat[order(dat$Day),]

# Test normality 
shapiro_test(dat, Porphyromonadaceae) # Normally distributed 

ggqqplot(dat,x = "Porphyromonadaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Porphyromonadaceae~Day) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Porphyromonadaceae_trajectories_vis, eval = TRUE}

# Get summary statistics 
dat %>% 
  group_by(Group, Day) %>% 
  get_summary_stats(Porphyromonadaceae, type = "common")

# Seperate data to make seperate plots for each group 
dat_con <- dat[dat$Group %in% c('Control'),] 
dat_low <- dat[dat$Group %in% c('Low'),] 
dat_med <- dat[dat$Group %in% c('Medium'),] 
dat_high <- dat[dat$Group %in% c('High'),]

# Set colors 
my_cols_con <- c("#fbb4ae", "#ff6666", "#CC0000")
my_cols_low <- c("#99CCFF","#3366CC","#003399")
my_cols_med <- c("darkseagreen2", "#00CC33", "green4")
my_cols_high <- c("#e9dbf9", "#c994c7", "#88419d")

# Visualise data 
plot_con <- dat_con %>%
  ggboxplot(x = "Day",
           y = "Porphyromonadaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#ff6666") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(7, 10), breaks = scales::pretty_breaks(n=4))+
  ylab("Absolute abundance (log)")+
  theme_classic()+
  ggtitle("Control")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank())+
  scale_fill_manual(values = my_cols_con)+
stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot_low <- dat_low %>%
  ggboxplot(x = "Day",
           y = "Porphyromonadaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#6699CC") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(7, 10), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("Low dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_low)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

# Visualise data 
plot_med <- dat_med %>%
  ggboxplot(x = "Day",
           y = "Porphyromonadaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#00CC33") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(7, 10), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("Medium dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_low)+
  scale_fill_manual(values = my_cols_med)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

# Visualise data 
plot_high <- dat_high %>%
  ggboxplot(x = "Day",
           y = "Porphyromonadaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#c994c7") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(7, 10), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("High dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_high)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

```

### Statistical testing 

```{r Porphyromonadaceae_trajectories_stat, eval = TRUE}

# Two-way anova for repeated measures 
two.way <- anova_test(data = dat, 
                      dv = !!sym("Porphyromonadaceae"), 
                      wid = !!sym("Animal"), 
                      between = !!sym("Group"),
                      within = !!sym("Day"))
get_anova_table(two.way) # Significant difference for Group and Day

# Post hoc tests 
stat.test.con <- dat_con %>% 
  t_test(Porphyromonadaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.low <- dat_low %>% 
  t_test(Porphyromonadaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.med <- dat_med %>% 
  t_test(Porphyromonadaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.high <- dat_high %>% 
  t_test(Porphyromonadaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

```


### Output plot
```{r Porphyromonadaceae_trajectories_output, eval = TRUE}

# Create output plot
My_Theme = theme(plot.title = element_text(size = 10)) 

plot_con_final <- plot_con + My_Theme + 
  stat_pvalue_manual(stat.test.con, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE)

plot_low_final <- plot_low + My_Theme + 
  stat_pvalue_manual(stat.test.low, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE, y.position = c(10)) 

plot_med_final <- plot_med + My_Theme + 
  stat_pvalue_manual(stat.test.med, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE) 

plot_high_final <- plot_high + My_Theme +  
  stat_pvalue_manual(stat.test.high, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE) 

plot_final <- ggarrange(plot_con_final, plot_low_final, plot_med_final, plot_high_final, ncol=4, nrow=1)

plot_final <- annotate_figure(plot_final, top = text_grob("Porphyromonadaceae", color = "black", face = "bold"))

filename <- paste0("plots/Absolute_abundance/Porphyromonadaceae.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 2000, height = 1400, units = "px", dpi = "print", device = "png", ))

# Clear the environment and release memory
 rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
 invisible(gc())
 
```


# Akkermansiaceae {.tabset .tabset-fade .tabset-pills}
## Day 9 
#### Prepare dataset 
```{r Akkermansiaceae_d09_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D09'),] 

# Test normality 
shapiro_test(dat, Akkermansiaceae) # Not normally distributed 

ggqqplot(dat,x = "Akkermansiaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Akkermansiaceae~Group) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Akkermansiaceae_d09_vis, eval = TRUE}

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Akkermansiaceae",
           fill = "Group") + 
  geom_point(size = 1, color = "black") +
  scale_y_continuous(limits=c(4, 10))+
  ylab("Absolute abundance (log)")+
  ggtitle("Akkermansiaceae (day 9)")+
  xlab(NULL)+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+ 
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot <- plot + geom_hline(yintercept=6, linetype="dashed", color = "black", size = 0.5)

# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Akkermansiaceae, type = "common")

```

#### Statistical testing 

```{r Akkermansiaceae_d09_stat, eval = TRUE}

# Kruskal Wallis test 
kruskal <- kruskal.test(Akkermansiaceae ~ Group, data = dat)
kruskal # Significant 

# Post hoc test: Dunn's test   
stat.test <- dat %>%
  dunn_test(Akkermansiaceae ~ Group)%>%
  adjust_pvalue(method = "fdr") %>%
  add_significance("p.adj") %>% 
  add_xy_position(x = "Group", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)


# Create output plots 
My_Theme = theme(
  plot.title = element_text(size = 12)) 

plot_final <- plot + 
  My_Theme +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE, y.position = c(9.5,10))

filename <- paste0("plots/Absolute_abundance/Akkermansiaceae_d09.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))
 
# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```


## Day 2 
#### Prepare dataset 
```{r Akkermansiaceae_d02_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")


# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D02'),] 

# Test normality 
shapiro_test(dat, Akkermansiaceae) # Not normally distributed 

ggqqplot(dat,x = "Akkermansiaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Akkermansiaceae~Group) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Akkermansiaceae_d02_vis, eval = TRUE}

# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Akkermansiaceae, type = "common")

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Akkermansiaceae",
           fill = "Group") + 
  scale_color_brewer(palette = "Pastel1")+
  geom_point(size = 1, color = "black") +
  ylab("Absolute abundance (log)")+
  xlab(NULL)+
  ggtitle("Akkermansiaceae (Day 2)")+
  theme_classic()+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot <- plot + geom_hline(yintercept=6, linetype="dashed", color = "black", size = 0.5)
  
```

#### Statistical testing 

```{r Akkermansiaceae_d02_stat, eval = TRUE}

# Kruskal Wallis test 
kruskal <- kruskal.test(Akkermansiaceae ~ Group, data = dat)
kruskal # not significant 


filename <- paste0("plots/Absolute_abundance/Akkermansiaceae_d02.png")
plot
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))
 
# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```


## Correlation with TT 
```{r correlation_Akkermansiaceae, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

My_Theme = theme(
  plot.title = element_text(size = 12))  

# Plot for absolute abundance day 2 vs TT day 2 
dat_D02 <- dat[dat$Day %in% c('D02'),] 

plot_D02 <- ggscatter(dat_D02, x = "TT_D02", y = "Akkermansiaceae", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (day 2)", ylab = "Absolute abundance (day 2)") + 
  theme_classic()+ggtitle("Akkermansiaceae")#+scale_y_continuous(limits=c(6,12))

filename <- paste0("plots/Absolute_abundance/Akkermansiaceae_corr_d02.png")
plot_D02 <- plot_D02 + My_Theme  
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))

# Plot for relative abundance day 5 vs TT day 5 
# Create the new dataset 
dat_D05 <- dat[dat$Day %in% c('D05'),] 

plot_D05 <- ggscatter(dat_D05, x = "TT_D05", y = "Akkermansiaceae", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (day 5)", ylab = "Absolute abundance (day 5)") + scale_y_continuous(limits=c(4, 10))+ theme_classic()+ggtitle("Akkermansiaceae")+geom_hline(yintercept=6, linetype="dashed", color = "black", size = 0.5)  


filename <- paste0("plots/Absolute_abundance/Akkermansiaceae_corr_d05.png")
plot_D05 <- plot_D05 + My_Theme
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))


# Plot for relative abundance day 9 vs TT average of D08/D10 
# Create the new dataset 
dat_av <- dat[dat$Day %in% c('D09'),] 

plot_av <- ggscatter(dat_av, x = "TT_AV", y = "Akkermansiaceae", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (average D08/D10)", ylab = "Absolute abundance (day 9)") + scale_y_continuous(limits=c(4, 10))+theme_classic()+ggtitle("Akkermansiaceae") + geom_hline(yintercept=6, linetype="dashed", color = "black", size = 0.5)   
  

filename <- paste0("plots/Absolute_abundance/Akkermansiaceae_corr_av.png")
plot_av <- plot_av + My_Theme
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))


# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```

## Trajectories 
#### Prepare dataset 
```{r Akkermansiaceae_trajectories_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor)

# Make sure that data is in correct order (for paired analysis)
dat <- dat[order(dat$Day),]

# Test normality 
shapiro_test(dat, Akkermansiaceae) # Not normally distributed 

ggqqplot(dat,x = "Akkermansiaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Akkermansiaceae~Day) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Akkermansiaceae_trajectories_vis, eval = TRUE}

# Get summary statistics 
dat %>% 
  group_by(Group, Day) %>% 
  get_summary_stats(Akkermansiaceae, type = "common")

# Seperate data to make seperate plots for each group 
dat_con <- dat[dat$Group %in% c('Control'),] 
dat_low <- dat[dat$Group %in% c('Low'),] 
dat_med <- dat[dat$Group %in% c('Medium'),] 
dat_high <- dat[dat$Group %in% c('High'),]

# Set colors 
my_cols_con <- c("#fbb4ae", "#ff6666", "#CC0000")
my_cols_low <- c("#99CCFF","#3366CC","#003399")
my_cols_med <- c("darkseagreen2", "#00CC33", "green4")
my_cols_high <- c("#e9dbf9", "#c994c7", "#88419d")

# Visualise data 
plot_con <- dat_con %>%
  ggboxplot(x = "Day",
           y = "Akkermansiaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#ff6666") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(4, 10), breaks = scales::pretty_breaks(n=4))+
  ylab("Absolute abundance (log)")+
  theme_classic()+
  ggtitle("Control")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank())+
  scale_fill_manual(values = my_cols_con)+
stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot_con <- plot_con + geom_hline(yintercept=6, linetype="dashed", color = "black", size = 0.5)

plot_low <- dat_low %>%
  ggboxplot(x = "Day",
           y = "Akkermansiaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#6699CC") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(4, 10), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("Low dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_low)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot_low <- plot_low + geom_hline(yintercept=6, linetype="dashed", color = "black", size = 0.5)

# Visualise data 
plot_med <- dat_med %>%
  ggboxplot(x = "Day",
           y = "Akkermansiaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#00CC33") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(4, 10), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("Medium dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_low)+
  scale_fill_manual(values = my_cols_med)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot_med <- plot_med + geom_hline(yintercept=6, linetype="dashed", color = "black", size = 0.5)

# Visualise data 
plot_high <- dat_high %>%
  ggboxplot(x = "Day",
           y = "Akkermansiaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#c994c7") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(4, 10), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("High dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_high)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot_high <- plot_high + geom_hline(yintercept=6, linetype="dashed", color = "black", size = 0.5)

```

### Statistical testing 

```{r Akkermansiaceae_trajectories_stat, eval = TRUE}

# Friedman test 
f <- friedman.test(Akkermansiaceae ~ Day|Animal, data = dat) # Significant 

# Post hoc tests 
stat.test.con <- dat_con %>% 
  wilcox_test(Akkermansiaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.low <- dat_low %>% 
  wilcox_test(Akkermansiaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.med <- dat_med %>% 
  wilcox_test(Akkermansiaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.high <- dat_high %>% 
  wilcox_test(Akkermansiaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

```

### Output plot
```{r Akkermansiaceae_trajectories_output, eval = TRUE}

# Create output plot
My_Theme = theme(plot.title = element_text(size = 10)) 

plot_con_final <- plot_con + My_Theme + 
  stat_pvalue_manual(stat.test.con, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE)

plot_low_final <- plot_low + My_Theme + 
  stat_pvalue_manual(stat.test.low, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE, y.position = c(9.5,10)) 

plot_med_final <- plot_med + My_Theme + 
  stat_pvalue_manual(stat.test.med, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE) 

plot_high_final <- plot_high + My_Theme +  
  stat_pvalue_manual(stat.test.high, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE) 

plot_final <- ggarrange(plot_con_final, plot_low_final, plot_med_final, plot_high_final, ncol=4, nrow=1)

plot_final <- annotate_figure(plot_final, top = text_grob("Akkermansiaceae", color = "black", face = "bold"))

filename <- paste0("plots/Absolute_abundance/Akkermansiaceae.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 2000, height = 1400, units = "px", dpi = "print", device = "png", ))

# Clear the environment and release memory
 rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
 invisible(gc())
 
```


# Bacteroides {.tabset .tabset-fade .tabset-pills}

## Day 9 
#### Prepare dataset 
```{r Bacteroides_d09_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")


# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D09'),] 

# Test normality 
shapiro_test(dat, Bacteroides) # Normally distributed 

ggqqplot(dat,x = "Bacteroides") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Bacteroides~Group) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Bacteroides_d09_vis, eval = TRUE}

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Bacteroides",
           fill = "Group") + 
  geom_point(size = 1, color = "black") +
  scale_y_continuous(limits=c(8,12))+
  ylab("Absolute abundance (log)")+
  xlab(NULL)+
  ggtitle("Bacteroides")+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))
  

# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Bacteroides, type = "common")

```

#### Statistical testing 

```{r Bacteroides_d09_stat, eval = TRUE}

# ANOVA
anova <- aov(Bacteroides ~ Group, data = dat)
summary(anova)

# Post hoc test 
stat.test <- dat %>% 
  t_test(Bacteroides~Group, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Group", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)


# Create output plots 
My_Theme = theme(
  plot.title = element_text(size = 12))  

plot_final <- plot + 
  My_Theme +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE, y.position = c(11.5,12)) 

filename <- paste0("plots/Absolute_abundance/Bacteroides_d09.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))
 
# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```

## Correlation with TT 
```{r correlation_Bacteroides, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

My_Theme = theme(
  plot.title = element_text(size = 12)) 

# Plot for relative abundance day 5 vs TT day 5 
# Create the new dataset 
dat_D05 <- dat[dat$Day %in% c('D05'),] 

plot_D05 <- ggscatter(dat_D05, x = "TT_D05", y = "Bacteroides", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (day 5)", ylab = "Absolute abundance (day 5)") + 
  theme_classic()+ggtitle("Bacteroides")+ scale_y_continuous(limits=c(8,12))

filename <- paste0("plots/Absolute_abundance/Bacteroides_corr_D05.png")
plot_D05 <- plot_D05 + My_Theme
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))
  

# Plot for relative abundance day 9 vs TT average of D08/D10 
# Create the new dataset 
dat_av <- dat[dat$Day %in% c('D09'),] 

plot_av <- ggscatter(dat_av, x = "TT_AV", y = "Bacteroides", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (average D08/D10)", ylab = "Absolute abundance (day 9)") + theme_classic()+ggtitle("Bacteroides")+ scale_y_continuous(limits=c(8, 12))
 
filename <- paste0("plots/Absolute_abundance/Bacteroides_corr_av.png")
plot_av <- plot_av + My_Theme
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))

# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```

# Phocaeicola{.tabset .tabset-fade .tabset-pills}

## Day 9 
#### Prepare dataset 
```{r Phocaeicola_d09_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D09'),] 

# Test normality 
shapiro_test(dat, Phocaeicola) # Normally distributed 

ggqqplot(dat,x = "Phocaeicola") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Phocaeicola~Group) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Phocaeicola_d09_vis, eval = TRUE}

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Phocaeicola",
           fill = "Group") + 
  geom_point(size = 1, color = "black") +
  scale_y_continuous(limits=c(7,12))+
  ylab("Absolute abundance (log)")+
  ggtitle("Phocaeicola")+
  xlab(NULL)+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Phocaeicola, type = "common")

```

#### Statistical testing 

```{r Phocaeicola_d09_stat, eval = TRUE}

# ANOVA 
anova <- aov(Phocaeicola ~ Group, data = dat)
summary(anova)

# Post hoc test 
stat.test <- dat %>% 
  t_test(Phocaeicola~Group, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Group", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)


# Create output plot
My_Theme = theme(
  plot.title = element_text(size = 12)) 

plot_final <- plot + 
  My_Theme +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE, y.position = c(11,11.5,12)) 

filename <- paste0("plots/Absolute_abundance/Phocaeicola_d09.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))
 
# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```


## Correlation with TT 
```{r correlation_Phocaeicola, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

My_Theme = theme(
  plot.title = element_text(size = 12)) 


# Plot for relative abundance day 5 vs TT day 5 
# Create the new dataset 
dat_D05 <- dat[dat$Day %in% c('D05'),] 

plot_D05 <- ggscatter(dat_D05, x = "TT_D05", y = "Phocaeicola", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (day 5)", ylab = "Absolute abundance (day 5)") + 
  theme_classic()+ ggtitle("Phocaeicola")+ scale_y_continuous(limits=c(7, 12))
  
filename <- paste0("plots/Absolute_abundance/Phocaeicola_corr_D05.png")
plot_D05 <- plot_D05 + My_Theme
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))

# Plot for relative abundance day 9 vs TT average of D08/D10 
# Create the new dataset 
dat_av <- dat[dat$Day %in% c('D09'),] 

plot_av <- ggscatter(dat_av, x = "TT_AV", y = "Phocaeicola", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (average D08/D10)", ylab = "Absolute abundance (day 9)") + theme_classic()+ ggtitle("Phocaeicola")+ scale_y_continuous(limits=c(7, 12))

filename <- paste0("plots/Absolute_abundance/Phocaeicola_corr_av.png")
plot_av <- plot_av + My_Theme
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))


# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```

# Longibaculum {.tabset .tabset-fade .tabset-pills}

## Day 9 
#### Prepare dataset 
```{r Longibaculum_d09_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")


# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D09'),] 

# Test normality 
shapiro_test(dat, Longibaculum) # not normally distributed 

ggqqplot(dat,x = "Longibaculum") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Longibaculum~Group) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Longibaculum_d09_vis, eval = TRUE}

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Longibaculum",
           fill = "Group") + 
  geom_point(size = 1, color = "black") +
  ylab("Absolute abundance (log)")+
  ggtitle("Longibaculum")+
  xlab(NULL)+
  scale_y_continuous(limits=c(4,12))+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))
  

plot <- plot + geom_hline(yintercept=6, linetype="dashed", color = "black", size = 0.5)


# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Longibaculum, type = "common")

```

#### Statistical testing 

```{r Longibaculum_d09_stat, eval = TRUE}

# Kruskal Wallis test 
kruskal <- kruskal.test(Longibaculum ~ Group, data = dat)
kruskal # significant 

# Post hoc test: Dunn's test   
stat.test <- dat %>%
  dunn_test(Longibaculum ~ Group)%>%
  adjust_pvalue(method = "fdr") %>%
  add_significance("p.adj") %>% 
  add_xy_position(x = "Group", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)


# Create output plots 
My_Theme = theme(plot.title = element_text(size = 12))


plot_final <- plot + My_Theme +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE, y.position = c(11,12)) 

 
filename <- paste0("plots/Absolute_abundance/Longibaculum_d09.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))

# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```

## Correlation with TT 
```{r correlation_Longibaculum, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

My_Theme = theme(
  plot.title = element_text(size = 12))

# Plot for relative abundance day 5 vs TT day 5 
# Create the new dataset 
dat_D05 <- dat[dat$Day %in% c('D05'),] 

plot_D05 <- ggscatter(dat_D05, x = "TT_D05", y = "Longibaculum", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (day 5)", ylab = "Absolute abundance (day 5)") + 
  theme_classic()+ggtitle("Longibaculum")+ scale_y_continuous(limits=c(4, 12))

plot_D05 <- plot_D05 + geom_hline(yintercept=6, linetype="dashed", color = "black", size = 0.5)
  
filename <- paste0("plots/Absolute_abundance/Longibaculum_corr_D05.png")
plot_D05 <- plot_D05 + My_Theme
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))


# Plot for relative abundance day 9 vs TT average of D08/D10 
# Create the new dataset 
dat_av <- dat[dat$Day %in% c('D09'),] 

plot_av <- ggscatter(dat_av, x = "TT_AV", y = "Longibaculum", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (average D08/D10)", ylab = "Absolute abundance (day 9)") + 
  theme_classic()+ggtitle("Longibaculum")+ scale_y_continuous(limits=c(4, 12))

plot_av <- plot_av + geom_hline(yintercept=6, linetype="dashed", color = "black", size = 0.5)

filename <- paste0("plots/Absolute_abundance/Longibaculum.png")
plot_av <- plot_av + My_Theme
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))


# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```


## **************************
## ***NOT INCLUDED***

The following analyses are not included in the manuscript 

# Amedibacillus {.tabset .tabset-fade .tabset-pills}

## Day 9 
#### Prepare dataset 
```{r Amedibacillus_d09_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")


# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D09'),] 

# Test normality 
shapiro_test(dat, Amedibacillus) # not normally distributed 

ggqqplot(dat,x = "Amedibacillus") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Amedibacillus~Group) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Amedibacillus_d09_vis, eval = TRUE}

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Amedibacillus",
           fill = "Group") + 
  geom_point(size = 1, color = "black") +
  ylab("Absolute abundance (log)")+
  ggtitle("Amedibacillus")+
  xlab(NULL)+
  scale_y_continuous(limits=c(4,10))+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))
  

plot <- plot + geom_hline(yintercept=6, linetype="dashed", color = "black", size = 0.5)


# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Amedibacillus, type = "common")

```

#### Statistical testing 

```{r Amedibacillus_d09_stat, eval = TRUE}

# Kruskal Wallis test 
kruskal <- kruskal.test(Amedibacillus ~ Group, data = dat)
kruskal # significant 

# Post hoc test: Dunn's test   
stat.test <- dat %>%
  dunn_test(Amedibacillus ~ Group)%>%
  adjust_pvalue(method = "fdr") %>%
  add_significance("p.adj") %>% 
  add_xy_position(x = "Group", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)


# Create output plots 
My_Theme = theme(plot.title = element_text(size = 12))

plot_final <- plot + My_Theme +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE)

filename <- paste0("plots/Absolute_abundance/Not_included/Amedibacillus_d09.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))

# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```

# Holdemania {.tabset .tabset-fade .tabset-pills}

## Day 9 
#### Prepare dataset 
```{r Holdemania_d09_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")


# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D09'),] 

# Test normality 
shapiro_test(dat, Holdemania) # not normally distributed 

ggqqplot(dat,x = "Holdemania") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Holdemania~Group) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Holdemania_d09_vis, eval = TRUE}

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Holdemania",
           fill = "Group") + 
  geom_point(size = 1, color = "black") +
  ylab("Absolute abundance (log)")+
  ggtitle("Holdemania")+
  xlab(NULL)+
  #scale_y_continuous(limits=c(4,12))+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))
  

plot <- plot + geom_hline(yintercept=6, linetype="dashed", color = "black", size = 0.5)


# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Holdemania, type = "common")

```

#### Statistical testing 

```{r Holdemania_d09_stat, eval = TRUE}

# Kruskal Wallis test 
kruskal <- kruskal.test(Holdemania ~ Group, data = dat)
kruskal # not significant 

# Create output plots 
My_Theme = theme(plot.title = element_text(size = 12))


plot_final <- plot + My_Theme  

 
filename <- paste0("plots/Absolute_abundance/Not_included/Holdemania_d09.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))

# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```


# Sutterellaceae {.tabset .tabset-fade .tabset-pills}

## Day 9 
#### Prepare dataset 
```{r Sutterellaceae_d09_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")


# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D09'),] 

# Test normality 
shapiro_test(dat, Sutterellaceae) # Not normally distributed 

ggqqplot(dat,x = "Sutterellaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Bacteroides~Group) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Sutterellaceae_d09_vis, eval = TRUE}

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Sutterellaceae",
           fill = "Group") + 
  geom_point(size = 1, color = "black") +
  scale_y_continuous(limits=c(4,10))+
  ylab("Absolute abundance (log)")+
  xlab(NULL)+
  ggtitle("Sutterellaceae")+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))
  
plot <- plot + geom_hline(yintercept=5.3, linetype="dashed", color = "black", size = 0.5)

# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Sutterellaceae, type = "common")

```

#### Statistical testing 

```{r Sutterellaceae_d09_stat, eval = TRUE}

# Kruskal Wallis test 
kruskal <- kruskal.test(Sutterellaceae ~ Group, data = dat)
kruskal # Significant 

# Post hoc test: Dunn's test   
stat.test <- dat %>%
  dunn_test(Sutterellaceae ~ Group)%>%
  adjust_pvalue(method = "fdr") %>%
  add_significance("p.adj") %>% 
  add_xy_position(x = "Group", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)


# Create output plots 
My_Theme = theme(
  plot.title = element_text(size = 12))  

plot_final <- plot + 
  My_Theme +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE, y.position = c(9.6,10)) 

filename <- paste0("plots/Absolute_abundance/Not_included/Sutterellaceae_d09.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))
 
# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```

## Correlation with TT 
```{r correlation_Sutterellaceae, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

My_Theme = theme(
  plot.title = element_text(size = 12)) 


# Plot for relative abundance day 5 vs TT day 5 
# Create the new dataset 
dat_D05 <- dat[dat$Day %in% c('D05'),] 

plot_D05 <- ggscatter(dat_D05, x = "TT_D05", y = "Sutterellaceae", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (day 5)", ylab = "Absolute abundance (day 5)") + 
  theme_classic()+ ggtitle("Sutterellaceae")+ scale_y_continuous(limits=c(4, 10))+geom_hline(yintercept=5.3, linetype="dashed", color = "black", size = 0.5)  
  
filename <- paste0("plots/Absolute_abundance/Not_included/Sutterellaceae_corr_D05.png")
plot_D05 <- plot_D05 + My_Theme
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))

# Plot for relative abundance day 9 vs TT average of D08/D10 
# Create the new dataset 
dat_av <- dat[dat$Day %in% c('D09'),] 

plot_av <- ggscatter(dat_av, x = "TT_AV", y = "Sutterellaceae", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (average D08/D10)", ylab = "Absolute abundance (day 9)") + theme_classic()+ ggtitle("Sutterellaceae")+ scale_y_continuous(limits=c(4, 10))+geom_hline(yintercept=5.3, linetype="dashed", color = "black", size = 0.5) 

filename <- paste0("plots/Absolute_abundance/Not_included/Sutterellaceae_corr_av.png")
plot_av <- plot_av + My_Theme
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))


# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```

## Trajectories 
#### Prepare dataset 
```{r Sutterellaceae_trajectories_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor)

# Make sure that data is in correct order (for paired analysis)
dat <- dat[order(dat$Day),]

# Test normality 
shapiro_test(dat, Sutterellaceae) # Not normally distributed 

ggqqplot(dat,x = "Sutterellaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Sutterellaceae~Day) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Sutterellaceae_trajectories_vis, eval = TRUE}

# Get summary statistics 
dat %>% 
  group_by(Group, Day) %>% 
  get_summary_stats(Sutterellaceae, type = "common")

# Seperate data to make seperate plots for each group 
dat_con <- dat[dat$Group %in% c('Control'),] 
dat_low <- dat[dat$Group %in% c('Low'),] 
dat_med <- dat[dat$Group %in% c('Medium'),] 
dat_high <- dat[dat$Group %in% c('High'),]

# Set colors 
my_cols_con <- c("#fbb4ae", "#ff6666", "#CC0000")
my_cols_low <- c("#99CCFF","#3366CC","#003399")
my_cols_med <- c("darkseagreen2", "#00CC33", "green4")
my_cols_high <- c("#e9dbf9", "#c994c7", "#88419d")

# Visualise data 
plot_con <- dat_con %>%
  ggboxplot(x = "Day",
           y = "Sutterellaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#ff6666") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(4, 10), breaks = scales::pretty_breaks(n=4))+
  ylab("Absolute abundance (log)")+
  theme_classic()+
  ggtitle("Control")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank())+
  scale_fill_manual(values = my_cols_con)+
stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot_con <- plot_con + geom_hline(yintercept=5.3, linetype="dashed", color = "black", size = 0.5)

plot_low <- dat_low %>%
  ggboxplot(x = "Day",
           y = "Sutterellaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#6699CC") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(4, 10), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("Low dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_low)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot_low <- plot_low + geom_hline(yintercept=5.3, linetype="dashed", color = "black", size = 0.5)

# Visualise data 
plot_med <- dat_med %>%
  ggboxplot(x = "Day",
           y = "Sutterellaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#00CC33") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(4, 10), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("Medium dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_low)+
  scale_fill_manual(values = my_cols_med)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot_med <- plot_med + geom_hline(yintercept=5.3, linetype="dashed", color = "black", size = 0.5)

# Visualise data 
plot_high <- dat_high %>%
  ggboxplot(x = "Day",
           y = "Sutterellaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#c994c7") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(4, 10), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("High dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_high)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot_high <- plot_high + geom_hline(yintercept=5.3, linetype="dashed", color = "black", size = 0.5)

```

### Statistical testing 

```{r Sutterellaceae_trajectories_stat, eval = TRUE}

# Friedman test 
f <- friedman.test(Sutterellaceae ~ Day|Animal, data = dat) # Significant 

# Post hoc tests 
stat.test.con <- dat_con %>% 
  wilcox_test(Sutterellaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.low <- dat_low %>% 
  wilcox_test(Sutterellaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.med <- dat_med %>% 
  wilcox_test(Sutterellaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.high <- dat_high %>% 
  wilcox_test(Sutterellaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

```

### Output plot
```{r Sutterellaceae_trajectories_output, eval = TRUE}

# Create output plot
My_Theme = theme(plot.title = element_text(size = 10)) 

plot_con_final <- plot_con + My_Theme + 
  stat_pvalue_manual(stat.test.con, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE)

plot_low_final <- plot_low + My_Theme + 
  stat_pvalue_manual(stat.test.low, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE, y.position = c(9.5,10)) 

plot_med_final <- plot_med + My_Theme + 
  stat_pvalue_manual(stat.test.med, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE, y.position = c(9.5,10)) 

plot_high_final <- plot_high + My_Theme +  
  stat_pvalue_manual(stat.test.high, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE) 

plot_final <- ggarrange(plot_con_final, plot_low_final, plot_med_final, plot_high_final, ncol=4, nrow=1)

plot_final <- annotate_figure(plot_final, top = text_grob("Sutterellaceae", color = "black", face = "bold"))

filename <- paste0("plots/Absolute_abundance/Not_included/Sutterellaceae.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 2000, height = 1400, units = "px", dpi = "print", device = "png", ))

# Clear the environment and release memory
 rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
 invisible(gc())
 
```

# Rikenellaceae {.tabset .tabset-fade .tabset-pills}

## Day 9 
#### Prepare dataset 
```{r Rikenellaceae_d09_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")


# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D09'),] 

# Test normality 
shapiro_test(dat, Rikenellaceae) # Normally distributed 

ggqqplot(dat,x = "Rikenellaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Rikenellaceae~Group) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Rikenellaceae_d09_vis, eval = TRUE}

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Rikenellaceae",
           fill = "Group") + 
  geom_point(size = 1, color = "black") +
  scale_y_continuous(limits=c(8,12))+
  ylab("Absolute abundance (log)")+
  xlab(NULL)+
  ggtitle("Rikenellaceae")+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))
  

# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Rikenellaceae, type = "common")

```

#### Statistical testing 

```{r Rikenellaceae_d09_stat, eval = TRUE}

# ANOVA
anova <- aov(Rikenellaceae ~ Group, data = dat)
summary(anova) # not significant 


# Create output plots 
My_Theme = theme(
  plot.title = element_text(size = 12))  

plot_final <- plot + My_Theme

filename <- paste0("plots/Absolute_abundance/Not_included/Rikenellaceae_d09.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))
 
# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```

# Prevotellaceae {.tabset .tabset-fade .tabset-pills}

## Day 9 
#### Prepare dataset 
```{r Prevotellaceae_d09_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")


# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D09'),] 

# Test normality 
shapiro_test(dat, Prevotellaceae) # Normally distributed 

ggqqplot(dat,x = "Prevotellaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Prevotellaceae~Group) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Prevotellaceae_d09_vis, eval = TRUE}

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Prevotellaceae",
           fill = "Group") + 
  geom_point(size = 1, color = "black") +
  scale_y_continuous(limits=c(8,12))+
  ylab("Absolute abundance (log)")+
  xlab(NULL)+
  ggtitle("Prevotellaceae")+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))
  

# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Prevotellaceae, type = "common")

```

#### Statistical testing 

```{r Prevotellaceae_d09_stat, eval = TRUE}

# ANOVA
anova <- aov(Prevotellaceae ~ Group, data = dat)
summary(anova) # Significant 

# Post hoc test 
stat.test <- dat %>% 
  t_test(Prevotellaceae~Group, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Group", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

# Create output plots 
My_Theme = theme(
  plot.title = element_text(size = 12))  

plot_final <- plot + 
  My_Theme +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE)#, y.position = c(11.5,12)) 

filename <- paste0("plots/Absolute_abundance/Not_included/Prevotellaceae_d09.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))
 
# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```

## Correlation with TT 
```{r correlation_Prevotellaceae, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

My_Theme = theme(
  plot.title = element_text(size = 12)) 

# Plot for relative abundance day 5 vs TT day 5 
# Create the new dataset 
dat_D05 <- dat[dat$Day %in% c('D05'),] 

plot_D05 <- ggscatter(dat_D05, x = "TT_D05", y = "Prevotellaceae", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (day 5)", ylab = "Absolute abundance (day 5)") + 
  theme_classic()+ggtitle("Prevotellaceae")+ 
  scale_y_continuous(limits=c(8, 12))
  
filename <- paste0("plots/Absolute_abundance/Not_included/Prevotellaceae_corr_D05.png")
plot_D05 <- plot_D05 + My_Theme
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))

# Plot for relative abundance day 9 vs TT average of D08/D10 
# Create the new dataset 
dat_av <- dat[dat$Day %in% c('D09'),] 

plot_av <- ggscatter(dat_av, x = "TT_AV", y = "Prevotellaceae", shape = 20, conf.int = FALSE, cor.coef = TRUE, cor.method = "spearman", xlab = "Transit time (average D08/D10)", ylab = "Absolute abundance (day 9)") + 
  theme_classic()+ggtitle("Prevotellaceae")+  
  scale_y_continuous(limits=c(8,12))

filename <- paste0("plots/Absolute_abundance/Not_included/Prevotellaceae_corr_av.png")
plot_av <- plot_av + My_Theme
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))


# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```


## Trajectories 
#### Prepare dataset 
```{r Prevotellaceae_trajectories_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")

# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor)

# Make sure that data is in correct order (for paired analysis)
dat <- dat[order(dat$Day),]

# Test normality 
shapiro_test(dat, Prevotellaceae) # Normally distributed 

ggqqplot(dat,x = "Prevotellaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Prevotellaceae~Day) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Prevotellaceae_trajectories_vis, eval = TRUE}

# Get summary statistics 
dat %>% 
  group_by(Group, Day) %>% 
  get_summary_stats(Prevotellaceae, type = "common")

# Seperate data to make seperate plots for each group 
dat_con <- dat[dat$Group %in% c('Control'),] 
dat_low <- dat[dat$Group %in% c('Low'),] 
dat_med <- dat[dat$Group %in% c('Medium'),] 
dat_high <- dat[dat$Group %in% c('High'),]

# Set colors 
my_cols_con <- c("#fbb4ae", "#ff6666", "#CC0000")
my_cols_low <- c("#99CCFF","#3366CC","#003399")
my_cols_med <- c("darkseagreen2", "#00CC33", "green4")
my_cols_high <- c("#e9dbf9", "#c994c7", "#88419d")

# Visualise data 
plot_con <- dat_con %>%
  ggboxplot(x = "Day",
           y = "Prevotellaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#ff6666") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(8, 12), breaks = scales::pretty_breaks(n=4))+
  ylab("Absolute abundance (log)")+
  theme_classic()+
  ggtitle("Control")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank())+
  scale_fill_manual(values = my_cols_con)+
stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

plot_low <- dat_low %>%
  ggboxplot(x = "Day",
           y = "Prevotellaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#6699CC") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(8, 12), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("Low dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_low)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

# Visualise data 
plot_med <- dat_med %>%
  ggboxplot(x = "Day",
           y = "Prevotellaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#00CC33") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(8, 12), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("Medium dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_low)+
  scale_fill_manual(values = my_cols_med)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

# Visualise data 
plot_high <- dat_high %>%
  ggboxplot(x = "Day",
           y = "Prevotellaceae",
           fill = "Day") + 
  geom_line(aes(group = Animal), color = "#c994c7") + 
  geom_point(size = 0.5, color = "black") +
  scale_y_continuous(limits=c(8, 12), breaks = scales::pretty_breaks(n=4))+
  ylab(NULL)+
  theme_classic()+
  ggtitle("High dose")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position="none")+ 
  theme(axis.title.x=element_blank(), 
        axis.line.y = element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank())+
  scale_fill_manual(values = my_cols_high)+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))

```

### Statistical testing 

```{r Prevotellaceae_trajectories_stat, eval = TRUE}

# Two-way anova for repeated measures 
two.way <- anova_test(data = dat, 
                      dv = !!sym("Prevotellaceae"), 
                      wid = !!sym("Animal"), 
                      between = !!sym("Group"),
                      within = !!sym("Day"))
get_anova_table(two.way) # Significant difference for Group 

# Post hoc tests 
stat.test.con <- dat_con %>% 
  t_test(Prevotellaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.low <- dat_low %>% 
  t_test(Prevotellaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.med <- dat_med %>% 
  t_test(Prevotellaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

stat.test.high <- dat_high %>% 
  t_test(Prevotellaceae~Day, paired = TRUE, p.adjust.method = "fdr") %>% 
  add_significance("p.adj") %>%
  add_xy_position(x = "Day", dodge = 0.8) %>%
  p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)

```


### Output plot
```{r Prevotellaceae_trajectories_output, eval = TRUE}

# Create output plot
My_Theme = theme(plot.title = element_text(size = 10)) 

plot_con_final <- plot_con + My_Theme + 
  stat_pvalue_manual(stat.test.con, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE)

plot_low_final <- plot_low + My_Theme + 
  stat_pvalue_manual(stat.test.low, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE) 

plot_med_final <- plot_med + My_Theme + 
  stat_pvalue_manual(stat.test.med, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE,y.position = c(11.8)) 

plot_high_final <- plot_high + My_Theme +  
  stat_pvalue_manual(stat.test.high, label = "p.adj.signif", tip.length = 0.01, size = 3.5, hide.ns = TRUE) 

plot_final <- ggarrange(plot_con_final, plot_low_final, plot_med_final, plot_high_final, ncol=4, nrow=1)

plot_final <- annotate_figure(plot_final, top = text_grob("Prevotellaceae", color = "black", face = "bold"))

filename <- paste0("plots/Absolute_abundance/Not_included/Prevotellaceae.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 2000, height = 1400, units = "px", dpi = "print", device = "png", ))

# Clear the environment and release memory
 rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
 invisible(gc())
 
```

# Eggerthellaceae {.tabset .tabset-fade .tabset-pills}

## Day 9 
#### Prepare dataset 
```{r Eggerthellaceae_d09_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")


# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D09'),] 

# Test normality 
shapiro_test(dat, Eggerthellaceae) # Normally distributed 

ggqqplot(dat,x = "Eggerthellaceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Eggerthellaceae~Group) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Eggerthellaceae_d09_vis, eval = TRUE}

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Eggerthellaceae",
           fill = "Group") + 
  geom_point(size = 1, color = "black") +
  scale_y_continuous(limits=c(8,11))+
  ylab("Absolute abundance (log)")+
  xlab(NULL)+
  ggtitle("Eggerthellaceae")+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))
  

# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Eggerthellaceae, type = "common")

```

#### Statistical testing 

```{r Eggerthellaceae_d09_stat, eval = TRUE}

# ANOVA
anova <- aov(Eggerthellaceae ~ Group, data = dat)
summary(anova) # Not significant 

# Create output plots 
My_Theme = theme(
  plot.title = element_text(size = 12))  

plot_final <- plot + My_Theme 

filename <- paste0("plots/Absolute_abundance/Not_included/Eggerthellaceae_d09.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))
 
# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```


# Deferribacteraceae {.tabset .tabset-fade .tabset-pills}
## Day 9 
#### Prepare dataset 
```{r Deferribacteraceae_d09_prep, eval = TRUE}

# Load data 
dat <- read_csv("input/absolute_abundance_log.csv")


# Turn relevant variables into factors and make sure data is in correct order 
dat <- dat %>% 
  mutate_at("Group", factor, levels = c("Control", "Low", "Medium", "High")) %>% 
  mutate_at("Treatment", factor, levels = c("Control", "Treatment"))%>%
  mutate_at("Day", factor, levels = c("D02", "D05", "D09")) %>% 
  mutate_at("Animal", factor) %>% 
  mutate_at("Treatment", factor)

dat <- dat[dat$Day %in% c('D09'),] 

# Test normality 
shapiro_test(dat, Deferribacteraceae) # Not normally distributed 

ggqqplot(dat,x = "Deferribacteraceae") 

# Levene's test (test for homogeneity)
dat %>% 
  levene_test(Deferribacteraceae~Group) # Assumption is met 

```

#### Visualization + summary statistics 
```{r Deferribacteraceae_d09_vis, eval = TRUE}

# Visualise data 
plot <- dat %>%
  ggboxplot(x = "Group",
           y = "Deferribacteraceae",
           fill = "Group") + 
  geom_point(size = 1, color = "black") +
  scale_y_continuous(limits=c(4,10))+
  ylab("Absolute abundance (log)")+
  xlab(NULL)+
  ggtitle("Deferribacteraceae")+
  theme_classic()+
  theme(legend.position="none")+ 
  scale_fill_brewer(palette = "Pastel1")+
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 2, position = position_dodge(.75))
  
plot <- plot + geom_hline(yintercept=6, linetype="dashed", color = "black", size = 0.5)

# Get summary statistics 
dat %>% 
  group_by(Group) %>% 
  get_summary_stats(Deferribacteraceae, type = "common")

```

#### Statistical testing 

```{r Deferribacteraceae_d09_stat, eval = TRUE}

# Kruskal Wallis test 
kruskal <- kruskal.test(Deferribacteraceae ~ Group, data = dat)
kruskal # Not significant 

# Create output plots 
My_Theme = theme(
  plot.title = element_text(size = 12))  

plot_final <- plot + My_Theme 

filename <- paste0("plots/Absolute_abundance/Not_included/Deferribacteraceae_d09.png")
plot_final
suppressMessages(ggsave(filename = filename, width = 1800, height = 1400, units = "px", dpi = "print", device = "png", ))
 
# Clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```
